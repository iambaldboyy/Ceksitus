<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    section { margin-bottom: 40px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { color: #222; }
    input, button { margin: 5px 0; padding: 8px; width: 100%; box-sizing: border-box; }
    button { cursor: pointer; background: #007BFF; color: white; border: none; border-radius: 4px; }
    .card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; background: #fafafa; }
    img { max-width: 100%; height: auto; }
  </style>
  <script type="module">
    import { auth, db, storage } from './firebase.js';
    import {
      onAuthStateChanged,
      signOut
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      collection, addDoc, getDocs, deleteDoc, doc
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import {
      ref, uploadBytes, getDownloadURL
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = "login.html";
      else loadAll();
    });

    function logout() {
      signOut(auth).then(() => window.location.href = "login.html");
    }
    window.logout = logout;

    function loadAll() {
      loadGames();
      loadUsers();
      loadBanner();
    }

    async function loadGames() {
      const gameList = document.getElementById('gameList');
      gameList.innerHTML = '';
      const snapshot = await getDocs(collection(db, "games"));
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <strong>${data.name}</strong><br>
          ${data.description}<br>
          <a href="${data.url}" target="_blank">Mainkan</a><br>
          <img src="${data.thumbnail}" width="100"/><br>
          <button onclick="deleteGame('${docSnap.id}')">Hapus</button>`;
        gameList.appendChild(div);
      });
    }

    window.addGame = async function () {
      const name = document.getElementById('gname').value;
      const desc = document.getElementById('gdesc').value;
      const url = document.getElementById('gurl').value;
      const file = document.getElementById('gthumb').files[0];

      if (!file || !name || !desc || !url) return alert("Semua kolom harus diisi!");

      const thumbRef = ref(storage, 'thumbnails/' + file.name);
      await uploadBytes(thumbRef, file);
      const thumbURL = await getDownloadURL(thumbRef);

      await addDoc(collection(db, "games"), {
        name, description: desc, url, thumbnail: thumbURL
      });

      alert("Game berhasil ditambahkan!");
      loadGames();
    }

    window.deleteGame = async function(id) {
      await deleteDoc(doc(db, "games", id));
      alert("Game dihapus");
      loadGames();
    }

    window.uploadBanner = async function () {
      const file = document.getElementById('bannerFile').files[0];
      if (!file) return alert("Pilih file banner dulu.");
      const bannerRef = ref(storage, 'banner/main.jpg');
      await uploadBytes(bannerRef, file);
      const url = await getDownloadURL(bannerRef);
      document.getElementById('bannerPreview').src = url;
      alert("Banner diperbarui");
    }

    async function loadBanner() {
      try {
        const url = await getDownloadURL(ref(storage, 'banner/main.jpg'));
        document.getElementById('bannerPreview').src = url;
      } catch (e) {
        console.log("No banner yet");
      }
    }

    async function loadUsers() {
      const userList = document.getElementById('userList');
      userList.innerHTML = 'Data pengguna hanya bisa dilihat via Firebase Console.<br>Lihat di: <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a>';
    }
  </script>
</head>
<body>
  <h1>Admin Panel</h1>
  <button onclick="logout()">Logout</button>

  <section>
    <h2>üéÆ Manajemen Game</h2>
    <input id="gname" placeholder="Nama Game" />
    <input id="gdesc" placeholder="Deskripsi" />
    <input id="gurl" placeholder="URL Game" />
    <input type="file" id="gthumb" />
    <button onclick="addGame()">Tambah Game</button>
    <div id="gameList"></div>
  </section>

  <section>
    <h2>üñºÔ∏è Banner Utama</h2>
    <input type="file" id="bannerFile" />
    <button onclick="uploadBanner()">Upload Banner</button><br />
    <img id="bannerPreview" src="" width="300"/>
  </section>

  <section>
    <h2>üë• Pengguna</h2>
    <div id="userList"></div>
  </section>
</body>
</html>
